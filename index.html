<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Embedding Explorer</title>
    <!-- Load D3 locally to avoid external CDN dependency -->
    <script src="node_modules/d3/dist/d3.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="container">
        <div class="main-panel" id="main-content">
            <div class="visualization-header">
                <div class="header-controls">
                    <div class="control-group">
                        <button class="tool-btn active" id="polygonBtn" data-mode="lasso" onclick="setSelectionMode('lasso')" title="Lasso Selection (Shift+L)" aria-label="Lasso selection mode">
                            <svg viewBox="0 0 24 24"><path d="M4 4Q8 2 12 6t8 2q0 6-8 10-4 2-8 0"/><circle cx="5" cy="19" r="2"/></svg>
                        </button>
                        <button class="tool-btn" id="selectBtn" data-mode="box" onclick="setSelectionMode('box')" title="Box Selection (Shift+B)" aria-label="Box selection mode">
                            <svg viewBox="0 0 24 24"><rect x="5" y="5" width="14" height="14"/></svg>
                        </button>
                        <button class="tool-btn" id="clearBtn" onclick="clearSelection()" title="Clear Selection (Shift+C)" aria-label="Clear selection">
                            <svg viewBox="0 0 24 24"><line x1="6" y1="6" x2="18" y2="18"/><line x1="6" y1="18" x2="18" y2="6"/></svg>
                        </button>
                    </div>
                    <div class="zoom-controls">
                        <button class="tool-btn" id="zoomInBtn" onclick="zoomIn()" title="Zoom In (+)" aria-label="Zoom in">
                            <svg viewBox="0 0 24 24"><circle cx="10" cy="10" r="6"/><line x1="10" y1="7" x2="10" y2="13"/><line x1="7" y1="10" x2="13" y2="10"/><line x1="14" y1="14" x2="20" y2="20"/></svg>
                        </button>
                        <button class="tool-btn" id="zoomOutBtn" onclick="zoomOut()" title="Zoom Out (-)" aria-label="Zoom out">
                            <svg viewBox="0 0 24 24"><circle cx="10" cy="10" r="6"/><line x1="7" y1="10" x2="13" y2="10"/><line x1="14" y1="14" x2="20" y2="20"/></svg>
                        </button>
                        <button class="tool-btn" id="resetBtn" onclick="resetZoom()" title="Reset Zoom (Home)" aria-label="Reset zoom">
                            <svg viewBox="0 0 24 24"><path d="M3 11L12 3l9 8v10H3z"/></svg>
                        </button>
                    </div>
                    <div class="data-controls">
                        <button class="tool-btn" id="uploadBtn" onclick="triggerUpload()" title="Upload CSV Dataset" aria-label="Upload dataset">
                            <svg viewBox="0 0 24 24"><path d="M12 5v12"/><path d="M5 12l7-7 7 7"/><path d="M5 19h14"/></svg>
                        </button>
                        <button class="tool-btn" id="demoBtn" onclick="resetToDemoData()" title="Load Demo Data" aria-label="Load demo data">
                            <svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-3-6"/><polyline points="21 3 21 9 15 9"/></svg>
                        </button>
                        <input type="file" id="uploadInput" accept=".csv" style="display:none" onchange="handleFileInput(event)">
                    </div>
                </div>
            </div>
            <div class="plot-container">
                <svg id="visualization" role="img" aria-label="Interactive scatter plot of text embeddings"></svg>
                <div id="tooltip" class="tooltip"></div>
            </div>
        </div>

        <div class="resize-handle" aria-hidden="true"></div>

        <div class="side-panel">
            <div class="panel-header">
                <div class="panel-header-content">
                    <h2>Analysis</h2>
                    <div class="stats" role="status" aria-live="polite">
                        <span>Total: <span id="totalPoints" aria-label="Total points">0</span></span>
                        <span>Selected: <span id="selectedPoints" aria-label="Selected points">0</span></span>
                    </div>
                </div>
                <div class="panel-header-controls">
                    <button id="collapseSidebarBtn" class="collapse-btn" title="Toggle sidebar" aria-label="Toggle sidebar">❮</button>
                    <button class="settings-btn" onclick="showSettings()" title="Settings" aria-label="Open settings">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 9 4.6V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </button>
                </div>
            </div>
            
            <div class="panel-tabs">
                <button class="tab-btn active" data-tab="preview">Preview</button>
                <button class="tab-btn" data-tab="analysis">Analysis</button>
                <button class="tab-btn" data-tab="categories">Categories</button>
            </div>

            <div class="tab-content active" id="previewTab">
                <details id="selectionSection" open>
                    <summary>Selection Preview</summary>
                    <div class="selection-info">
                        <div id="selectionPreview" role="region" aria-label="Selection preview" aria-live="polite">
                            <p class="empty-state">
                                Select points to view details
                            </p>
                        </div>
                    </div>
                </details>

            </div>

            <div class="tab-content" id="analysisTab">
                <details id="promptSection">
                    <summary>Analysis Prompt</summary>
                    <div class="action-panel">
                        <label for="promptInput" class="prompt-label">Analysis Prompt</label>
                        <textarea class="prompt-input" id="promptInput" placeholder="Enter your analysis prompt..." aria-describedby="prompt-help">Analyze these items and identify common themes, patterns, or groupings.</textarea>
                        <p id="prompt-help" class="visually-hidden">Enter a prompt describing how the selection should be analyzed.</p>
                        <button class="button" id="analyzeBtn" onclick="showConfirmation()" disabled aria-describedby="analyze-help">
                            Analyze Selection
                        </button>
                        <p id="analyze-help" class="visually-hidden">Send the selected points and prompt to the analysis service.</p>
                    </div>
                </details>
            </div>
            
            <div class="tab-content" id="categoriesTab">
                <div class="legend-panel">
                    <label for="colorFieldSelect" class="legend-title">Color By</label>
                    <select id="colorFieldSelect" class="settings-select" style="margin-bottom: 12px;"></select>
                    <div id="legendPanel" class="legend-items">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="confirmModal" role="dialog" aria-labelledby="confirm-title" aria-modal="true">
        <div class="modal-content">
            <h3 id="confirm-title">Confirm Analysis Request</h3>
            <p style="color: #aaa; margin-bottom: 20px; font-size: 16px;">
                You're about to send <span id="confirmCount" style="color: #4a9eff; font-weight: 700; font-size: 18px;">0</span> data items for analysis.
            </p>
            
            <div class="cost-breakdown">
                <div class="cost-item">
                    <span>Data to analyze:</span>
                    <span id="costTexts">0</span>
                </div>
                <div class="cost-item">
                    <span>Estimated tokens:</span>
                    <span id="costTokens">0</span>
                </div>
                <div class="cost-item">
                    <span>Model:</span>
                    <span id="costModel">GPT-3.5-Turbo</span>
                </div>
                <div class="cost-item">
                    <span>Estimated cost:</span>
                    <span id="costEstimate">$0.00</span>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideConfirmation()" aria-label="Cancel analysis">Cancel</button>
                <button class="confirm-btn" onclick="proceedWithAnalysis()" aria-label="Proceed with analysis">Proceed</button>
            </div>
        </div>
    </div>
    
    <div class="settings-modal" id="settingsModal" role="dialog" aria-labelledby="settings-title" aria-modal="true">
        <div class="settings-content">
            <div class="settings-header">
                <h3 id="settings-title">Settings</h3>
                <button class="close-settings" onclick="hideSettings()" aria-label="Close settings">×</button>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">API Key</label>
                <div class="api-key-group">
                    <input type="password" 
                           class="settings-input" 
                           id="apiKeyInput" 
                           placeholder="sk-..."
                           autocomplete="off">
                    <button class="toggle-visibility" onclick="toggleApiKeyVisibility()" title="Toggle visibility" aria-label="Toggle API key visibility">
                        <span id="visibilityIcon" aria-hidden="true">👁</span>
                    </button>
                </div>
                <p class="settings-help">Your OpenAI API key. This is stored locally in your browser.</p>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">Model</label>
                <select class="settings-select" id="modelSelect">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo ($0.002/1K tokens)</option>
                    <option value="gpt-4">GPT-4 ($0.03/1K tokens)</option>
                    <option value="gpt-4-turbo-preview">GPT-4 Turbo ($0.01/1K tokens)</option>
                </select>
                <p class="settings-help">Select the model to use for analysis. Prices are approximate.</p>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">API Endpoint</label>
                <input type="text" 
                       class="settings-input" 
                       id="endpointInput" 
                       value="https://api.openai.com/v1/chat/completions">
                <p class="settings-help">API endpoint URL. Change this only if using a custom endpoint.</p>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">Max Tokens</label>
                <input type="number" 
                       class="settings-input" 
                       id="maxTokensInput" 
                       value="1000" 
                       min="100" 
                       max="4000">
                <p class="settings-help">Maximum tokens for the response. Higher values allow longer responses.</p>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">Display Fields</label>
                <div class="checkbox-group" id="displayFieldsGroup">
                    <!-- Dynamically populated -->
                </div>
                <p class="settings-help">Select which fields to show in the selection preview.</p>
            </div>
            
            <div class="settings-section">
                <label class="settings-label">API Fields</label>
                <div class="checkbox-group" id="apiFieldsGroup">
                    <!-- Dynamically populated -->
                </div>
                <p class="settings-help">Select which fields to include when sending data to the API.</p>
            </div>
            
            <div class="warning-box">
                <strong>⚠️ Security Notice:</strong> Your API key is stored in your browser's local storage. Never share your API key or use it on untrusted websites.
            </div>
            
            <div style="background-color: rgba(74, 158, 255, 0.1); border: 2px solid rgba(74, 158, 255, 0.3); border-radius: 8px; padding: 16px; margin-top: 16px;">
                <strong style="color: #4a9eff;">💡 Tip:</strong> 
                <span style="color: #aaa;">The "content" field is always included by default. Select additional fields to enrich your analysis with metadata like categories, dates, or custom attributes.</span>
            </div>
            
            <div class="settings-footer">
                <button class="cancel-settings" onclick="hideSettings()" aria-label="Cancel settings changes">Cancel</button>
                <button class="save-settings" onclick="saveSettings()" aria-label="Save settings changes">Save Settings</button>
            </div>
        </div>
    </div>
    
    <div class="results-panel" id="resultsPanel" role="region" aria-labelledby="results-title">
        <div class="results-header">
            <h3 id="results-title" style="margin: 0; font-size: 16px;">Analysis Results</h3>
            <button class="close-results" onclick="hideResults()" aria-label="Close results panel">×</button>
        </div>
        <div class="results-content" id="resultsContent" role="log" aria-live="polite"></div>
    </div>

    <script type="module" src="js/app.js?v=2.0"></script>
</body>
</html>